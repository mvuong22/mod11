import java.util.ArrayList;
import java.util.List;

/**
 * Main controller for the whale-tracking app.
 * <p>
 * The {@code AppController} basically acts as the “middle person” between the
 * user interface (like {@code MenuUI}) and the data layer ({@link WhaleRepository}).
 * Any time the user wants to add, remove, update, or look at whales, the UI calls
 * this controller, which then handles the logic and talks to the repository.
 * </p>
 *
 * <p><b>What this controller is responsible for:</b></p>
 * <ul>
 *     <li>Checking user input with {@link WhaleValidator} before storing anything.</li>
 *     <li>Turning raw text (like a status typed by the user) into real model types
 *         such as {@link ConservationStatus}.</li>
 *     <li>Passing whale objects into {@link WhaleRepository} to save or update them.</li>
 *     <li>Providing extra features like a simple conservation overview.</li>
 * </ul>
 *
 * <p><b>How it works with other classes:</b></p>
 * <ul>
 *     <li>{@link WhaleRepository} — stores all whale data.</li>
 *     <li>{@link Whale} — the actual whale objects being created and updated.</li>
 *     <li>{@link WhaleValidator} — makes sure inputs are valid before saving.</li>
 *     <li>{@link ConservationStatus} — used when converting the whale’s status.</li>
 *     <li>{@code MenuUI} — calls the controller based on what the user picks.</li>
 * </ul>
 *
 * <p><b>Quick example of how a UI might use this:</b></p>
 * <pre>{@code
 * AppController controller = new AppController();
 *
 * List<String> commonNames = List.of("Blue whale", "Great blue whale");
 * List<String> habitats = List.of("Open ocean", "Deep sea");
 *
 * boolean added = controller.addWhale(
 *     "BALAENOPTERA_MUSCULUS",
 *     "Balaenoptera musculus",
 *     commonNames,
 *     30.0,
 *     150000.0,
 *     "Endangered",
 *     habitats
 * );
 *
 * if (added) {
 *     System.out.println("Whale successfully added!");
 * } else {
 *     System.out.println("Something went wrong. Check your inputs or ID.");
 * }
 * }</pre>
 */
public class AppController {

    private WhaleRepository repository;

    /**
     * Builds a new {@code AppController} with its own {@link WhaleRepository}.
     * <p>
     * This is the normal setup — one controller and one repository running
     * throughout the whole program session.
     * </p>
     */
    public AppController() {
        this.repository = new WhaleRepository();
    }

    /**
     * Tries to add a new {@link Whale} into the system using the details the user provided.
     * <p>
     * The method first checks every input using {@link WhaleValidator}. If anything looks
     * wrong (bad ID, empty lists, negative numbers), the method returns {@code false}.
     * Otherwise, it converts the status string into a {@link ConservationStatus}, creates
     * a new {@link Whale}, and sends it to the repository to be saved.
     * </p>
     *
     * @param id             unique species ID for the whale
     * @param scientificName the scientific name (ex: "Balaenoptera musculus")
     * @param commonNames    list of common names this whale is known by
     * @param length         whale length in meters; must be positive
     * @param weight         whale weight in kg; must be positive
     * @param status         text status like "Endangered" or "Least Concern"
     * @param habitats       list of habitats where the whale is found
     * @return {@code true} if the whale passed validation and was saved,
     *         {@code false} if validation failed or the repository rejected it
     * @throws IllegalArgumentException if {@code status} cannot be converted
     *                                  to a valid {@link ConservationStatus}
     */
    public boolean addWhale(String id, String scientificName, List<String> commonNames,
                            double length, double weight, String status, List<String> habitats) {

        if (!WhaleValidator.isValidSpeciesId(id) ||
            !WhaleValidator.isValidScientificName(scientificName) ||
            !WhaleValidator.isValidList(commonNames) ||
            !WhaleValidator.isValidPositiveDouble(length) ||
            !WhaleValidator.isValidPositiveDouble(weight) ||
            !WhaleValidator.isValidConservationStatus(status) ||
            !WhaleValidator.isValidList(habitats)) {
            return false;
        }

        ConservationStatus cs = ConservationStatus.valueOf(status.toUpperCase().replace(" ", "_"));
        Whale whale = new Whale(id, scientificName, commonNames, length, weight, cs, habitats);
        return repository.addWhale(whale);
    }

    /**
     * Removes a whale from the system using its ID.
     * <p>
     * If the repository is empty, removal isn’t possible. Otherwise, the method
     * tries to remove the whale and returns whatever the repository returns.
     * </p>
     *
     * @param id the ID of the whale to remove
     * @return {@code true} if the whale was removed,
     *         {@code false} if the list is empty or no whale has that ID
     */
    public boolean removeWhale(String id) {
        if (repository.getAllWhales().isEmpty()) return false;
        return repository.removeWhale(id);
    }

    /**
     * Updates an existing whale’s details using its ID.
     * <p>
     * First it checks whether the whale list is empty or the ID doesn’t exist.
     * If the whale exists, its status string is converted to a {@link ConservationStatus}
     * and a new updated {@link Whale} is created and saved.
     * </p>
     *
     * @param id             ID of the whale to update
     * @param scientificName new scientific name
     * @param commonNames    new common names
     * @param length         updated length (must be positive)
     * @param weight         updated weight (must be positive)
     * @param status         updated status, converted to {@link ConservationStatus}
     * @param habitats       updated habitats list
     * @return {@code true} if the ID existed and the update went through,
     *         {@code false} otherwise
     * @throws IllegalArgumentException if {@code status} can't be converted
     */
    public boolean updateWhale(String id, String scientificName, List<String> commonNames,
                               double length, double weight, String status, List<String> habitats) {

        if (repository.getAllWhales().isEmpty()) return false;

        Whale existing = repository.getWhaleById(id);
        if (existing == null) return false;

        ConservationStatus cs = ConservationStatus.valueOf(status.toUpperCase().replace(" ", "_"));
        Whale updated = new Whale(id, scientificName, commonNames, length, weight, cs, habitats);
        return repository.updateWhale(id, updated);
    }

    /**
     * Prints out information about every whale in the system.
     * <p>
     * If there are no whales yet, it prints a friendly message. Otherwise it loops
     * through every whale and calls {@link Whale#display()}.
     * </p>
     */
    public void displayAll() {
        List<Whale> whales = repository.getAllWhales();
        if (whales.isEmpty()) {
            System.out.println("\nHmmm.. Looks like your log doesn't have any whales yet. Let's try adding some!");
        } else {
            for (Whale w : whales) w.display();
        }
    }

    /**
     * Shows a conservation breakdown of all whales in the system.
     * <p>
     * This groups whales by their {@link ConservationStatus} and prints how many
     * species fall into each category. If the list is empty, it reminds the user
     * to add some whales first.
     * </p>
     */
    public void conservationOverview() {
        List<Whale> whales = repository.getAllWhales();

        if (whales.isEmpty()) {
            System.out.println("\nHold your flippers Explorer! There's no whales yet, add some whales first.");
            return;
        }

        System.out.println("\n<====== Conservation Overview ======>\n");

        for (ConservationStatus cs : ConservationStatus.values()) {
            List<String> species = new ArrayList<>();

            for (Whale w : whales) {
                if (w.getConservationStatus() == cs) {
                    species.add(w.getScientificName());
                }
            }

            System.out.println(cs + " (" + species.size() + "): " + String.join(", ", species));
        }

        System.out.println("\nSorted & saved!");
    }

    /**
     * Returns every whale stored in the repository.
     * <p>
     * The UI mainly uses this when it needs to show lists or search through whales.
     * </p>
     *
     * @return list of all whales (may be empty, but never {@code null})
     */
    public List<Whale> getAllWhales() {
        return repository.getAllWhales();
    }

    /**
     * Finds one whale in the system using its ID.
     *
     * @param id ID of the whale to look up
     * @return the matching {@link Whale}, or {@code null} if it doesn't exist
     */
    public Whale getWhaleById(String id) {
        return repository.getWhaleById(id);
    }
}
